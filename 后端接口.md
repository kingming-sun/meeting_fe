
1. 概要

---

TransNoteAI 后端服务，支持用户管理、前后端数据交互、任务调度、文件管理、数据库管理等。

代码库地址：https://github.com/InftyMing/TransNote-AI
开发分支：dev


2. 服务地址

---

环境类型
域名
说明
dev环境
{url_dev}
（待补充）开发环境，研发自测用
test环境
{url_test}
（待补充）测试环境，测试阶段
prod环境
{url}
（待补充）生产环境，承担线上流量



3. 业务流程

---



4. 数据库表设计

---

4.1 基本信息

1. 数据库类型：PostgreSQL
2. 实例数量：2（主从 1+1）
3. 数据库名称：
  1. dev环境：tnai_dev
  2. test环境：tnai_test
  3. prod环境：tnai_prod
4. 库表名称： 
表名
库表含义
users
用户信息表
tasks
任务信息表
files
文件信息表
rsa_key_versions
密钥版本表


4.2 库表设计

4.2.1 users - 用户信息表
Column
类型
约束/索引
注释
说明
user_id
BIGSERIAL
PRIMARY KEY
用户唯一 ID（自增）

username
VARCHAR(30)
UNIQUE NOT NULL
用户名

email
VARCHAR(50)
UNIQUE NOT NULL
邮箱

encrypted_password
BYTEA
NOT NULL
用户加密口令

rsa_key_version
INT
NOT NULL
加密时使用的公钥版本

user_tag
INT
NOT NULL DEFAULT 1
用户标签
0-管理员，1-普通用户，2-VIP用户, 3-内测用户, 9-黑名单用户
total_space
INT
NOT NULL
用户可缓存文件总空间
单位MiB，普通用户默认1G，VIP及内测用户默认10G，需要确定一下这个策略是否合理
remain_space

INT

NOT NULL
用户剩余可缓存文件总空间
单位MiB，注意每次用户创建任务，生产数据文件时，都需要更新此字段；当该字段为负值时，不会马上中断未完成的任务，而是等任务结束后，显示剩余缓存空间不足，无法创建新的任务。
task_validity_period
INT
NOT NULL
缓存任务有效期
单位天，普通用户缓存3天，VIP及内测用户缓存7天
created_at
TIMESTAMPTZ
NOT NULL DEFAULT NOW()
记录创建时间
带时区时间，支持按时间范围查询，下同
updated_at
TIMESTAMPTZ

NOT NULL DEFAULT NOW()
记录更新时间


索引：


TODO:
1. 需要确认下用户管理规则，是否同时对用户缓存文件空间和用户体验时长进行限制？限制策略是怎样的？


4.2.2  tasks - 任务信息表
Column
类型
约束/索引
注释
说明
task_id
BIGSERIAL
PRIMARY KEY
任务唯一ID（自增）

user_id
BIGINT
NOT NULL REFERENCES users(user_id)
任务所属用户id（外键）

task_name
VARCHAR(30)
NOT NULL DEFAULT task_id
任务名称

task_status
INT
NOT NULL DEFAULT 0
任务状态
- -2: 任务异常
- -1: 任务已过期
- 0: 任务已创建
- 1: 任务完成
expire_at
BIGINT
NOT NULL
任务过期时间
UNIX时间戳，单位秒
task_size
INT
NOT NULL DEFAULT 0
任务内文件总缓存空间

task_tag
VARCHAR(10)

任务标签
预留字段
created_at
TIMESTAMPTZ
NOT NULL DEFAULT NOW()
记录创建时间
带时区时间，支持按时间范围查询，下同
updated_at
TIMESTAMPTZ

NOT NULL DEFAULT NOW()
记录更新时间

索引：



4.2.3 files - 文件信息表
Column
类型
约束/索引
注释
说明
file_id
BIGSERIAL
PRIMARY KEY
文件唯一 ID（自增）

user_id
BIGINT
NOT NULL REFERENCES users(user_id)
文件所属用户ID（外键）

task_id
BIGINT
NOT NULL REFERENCES tasks(task_id)
文件所属任务ID（外键）

file_name
VARCHAR(50)
NOT NULL
文件名称

file_tag
INT
NOT NULL
文件标签
0-原始文件；1-总结文件；2-脑图文件；3-AI生成文件
file_size
BITINT
NOT NULL DEFAULT 0
文件大小
单位Bytes
file_type
TEXT
NOT NULL 
文件类型

file_Md5
CHAR(32)
NOT NULL UNIQUE
md5校验码
固定32位16进制字符串
file_Addr
TEXT[]
NOT NULL DEFAULT '{}'::TEXT[]
文件存储路径
文件在文件服务上存储地址，因为可能分块存储，所以这里用列表记录
created_at
TIMESTAMPTZ
NOT NULL DEFAULT NOW()
记录创建时间
带时区时间，支持按时间范围查询，下同
updated_at
TIMESTAMPTZ

NOT NULL DEFAULT NOW()
记录更新时间

索引：
version INT PRIMARY KEY,  -- 版本号（如1,2,3...）
  public_key BYTEA NOT NULL,  -- 公钥（用于加密）
  private_key_encrypted BYTEA NOT NULL,  -- 加密后的私钥（需用主密钥解密）
  effective_time TIMESTAMPTZ NOT NULL,  -- 生效时间
  is_active BOOLEAN NOT NULL DEFAULT TRUE  -- 是否当前活跃版本


4.2.4 rsa_key_versions - 密钥版本表
Column
类型
约束/索引
注释
说明
id
BIGSERIAL
PRIMARY KEY
自增ID

version
BIGINT
NOT NULL UNIQUE
版本号

public_key
BYTEA
NOT NULL 
公钥用于加密

private_key_encrypted
BYTEA
NOT NULL
密后的私钥（需用主密钥解密）

expire_at
BIGINT
NOT NULL
过期时间
单位秒，UNIX时间戳
file_size
BITINT
NOT NULL DEFAULT 0
文件大小
单位Bytes
file_type
TEXT
NOT NULL 
文件类型

file_Md5
CHAR(32)
NOT NULL UNIQUE
md5校验码
固定32位16进制字符串
file_Addr
TEXT[]
NOT NULL DEFAULT '{}'::TEXT[]
文件存储路径
文件在文件服务上存储地址，因为可能分块存储，所以这里用列表记录
created_at
TIMESTAMPTZ
NOT NULL DEFAULT NOW()
记录创建时间
带时区时间，支持按时间范围查询，下同
updated_at
TIMESTAMPTZ

NOT NULL DEFAULT NOW()
记录更新时间




5. 接口说明

---

5.1 HTTP状态码 & 业务码对照表

http状态码
http状态码含义
业务码区间 / code
业务码含义
200
业务正常，处理成功
0

0: 服务接口正常，处理成功
code > 0: 服务接口异常，处理失败
400
请求参数错误或格式无效
（0, 1000)
1: 请求参数不存在
2: 请求参数类型 / 格式错误
100: 邮箱格式错误
401/403
权限错误
[1000, 2000)
1000: 无访问权限
1001: 用户口令无效（公钥过期）
1002: token过期
1003: 邮箱验证码过期 
404
资源不存在
[2000, 3000)
2000: 用户信息不存在
2001: 文件记录不存在（数据库）
2002: 文件过期或不存在（文件服务）
500

服务器内部错误
[3000, 4000)
3000: 接口内部逻辑异常
3100: 后端服务链接异常 / 超时
3200: 数据库链接异常 / 超时




5.2  用户管理


5.2.1 【POST】用户登录

1. 基础信息
信息项
规范
说明
API 地址
/api/v1/auth/login

请求方式
POST

传输协议
HTTPS

数据格式
JSON（Content-Type: application/json）
请求、响应均为json格式
请求头
1. X-Request-Id
2. Authorization: Bearer {token}
3. Content-Type: application/json
关于 X-Request-Id：目前暂时不知道云服务厂商在网关流量接入时是否可以生成，如果无法生成，则需要前端生成，可以考虑雪花算法
权限要求
无需登陆


2. 请求体
参数名称
参数类型
默认值
是否必填
说明
username
string
""
Y
用户名，30字符以内，支持数字、大小写字母、下划线
password

string
""

Y
用户密码/口令，前端 RSA-OAEP 公钥加密，后端私钥解密；
公钥每30天轮换一次，需要前端通过后端接口请求获取，获取后缓存或写入配置文件，避免每次用户登录都单独请求公钥；
加密参数 MGF1-SHA256，密钥长度2048
expireAt
int64
{cur_time} + 3600*4
N
token过期时间，UNIX时间，单位秒(s)，默认当前UNIX时间+4h

3. 成功响应
{
    "code": 0,    // 业务码
    "msg": "success",    // 提示信息
    "data": {    // 消息体
        "accessToken": "",  // string, 访问令牌（用于接口鉴权，有效期短，eg: 4小时）
        "refreshToken": "", // string, 刷新令牌（用于获取新accessToken，有效期长，eg: 1天）
        "userInfo": {    // 用户信息
            "userId": "",    // string, 用户唯一标识
            "username": "",    // string, 用户名
            "tag": 1    // uint8, 用户分级: 0-管理员，1-普通用户，2-VIP用户, 3-内测用户, 9-黑名单用户
            "totalDur": 3600,    // int32, 单位秒，用户能体验的总时长
            "remainDur": 1409,    // int32, 单位秒，用户剩余体验时长
            "totalSpace": 1000,    // int32, 单位MiB，用户文件缓存总空间
            "remainSpace": 340,    // int32, 单位MiB，用户剩余文件缓存空间
            "taskValidity": 3   // int64, 单位天，缓存任务文件有效期（普通用户：3d，VIP用户：7d）
        }
    },
    "reqId": ""    // 请求id，用于问题排查, 雪花算法生成
}

4. 失败响应
{
    "code": 1,    // 业务码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}



5.2.2 【GET】获取 RSA-OEAP 公钥

1. 基础信息
信息项
规范
说明
API 地址
/api/v1/auth/crypto/public-key
获取公钥
请求方式
GET

传输协议
HTTPS

数据格式
URL查询参数
请求为URL查询参数，响应为json格式
请求头
1. X-Request-Id
2. Authorization: Bearer {token}

权限要求
需管理员token
管理员token可以通过先行登陆管理员账户获取；也可以注册长期token，静态写入代码（不建议）

2. 请求参数
参数名称
参数类型
默认值
是否必填
说明
version
-
-
N
1. 版本号，用时间戳表示（年+月，如：202511）；
2. 公钥每30天更新一次；
3. 参数为空不填时，默认从数据库中提取最新的公钥生成记录，与当前时间做对比：
  1. 当前时间 - 最新数据库生成时间 < 30d，返回缓存中最新公钥；
  2. 当前时间 - 最新数据库生成时间 >= 30d，生成新的公钥，更新数据库，返回最新生成的公钥

3. 成功响应
{
    "code": 0,    // 业务码
    "msg": "success",    // 提示信息
    "data": {    // 消息体
        "publicKey": "",    // string 公钥名称
        "algorithm": "RSA-OAEP",    // string, 加密算法，固定为 RSA-OAEP
        "hash": "SHA-256",    // string, 哈希函数，固定 SHA-256
        "maskFunc": "MGF1",    // string, 掩码生成函数，固定 MGF1
        "keyLen": 2048,    // int32, 密钥长度，固定 2048
        "expireAt": 1736764800,    // int64, 单位秒，UNIX时间戳，公钥过期时间
    },
    "reqId": ""    // 请求id，用于问题排查
}

4. 失败响应
{
    "code": 3000,    // 业务码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}



5.2.3 【POST】用户注册

1. 基础信息
信息项
规范
说明
API 地址
/api/v1/auth/register

请求方式
POST

传输协议
HTTPS

数据格式
JSON（Content-Type: application/json）
请求、响应均为json格式
请求头
1. X-Request-Id
2. Authorization: Bearer {token}
3. Content-Type: application/json

权限要求
无需登录


2. 请求体
参数名称
参数类型
默认值
是否必填
说明
username
string
"{email}"
N
1. 用户名，默认与邮箱一致
2. 30字符以内，支持数字、大小写字母、下划线
password
string
""
Y
1. 用户密码/口令
2. 格式规范：8-20 位，要求必须包含数字、大写字母、小写字母、特殊字符（下划线_、星号*、小数点.）中的三种
3. 前端 RSA-OAEP 公钥加密
email
string
""
Y
用户邮箱
emailCode
string
""
Y
用户邮箱验证码
zone
string
""
N
用户所在国家/地区

3. 成功响应
{
    "code": 0,    // 业务码
    "msg": "success",    // 提示信息
    "data": {
        "userId": "",    // string, 用户唯一ID
        "username": "",    // string, 用户名
        "email": "",    // string, 邮箱
        "registerTs": 1736764800    // int64, 单位秒，注册时间，UNIX时间戳
    },
    "reqId": ""    // 请求id，用于问题排查
}

4. 失败响应
{
    "code": 1002,    // 状态码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}



5.2.4 【POST】获取邮箱验证码

1. 基础信息
信息项
规范
说明
API 地址
/api/auth/send-email-code

请求方式
POST

传输协议
HTTPS

数据格式
JSON（Content-Type: application/json）
请求、响应均为json格式
请求头
1. X-Request-Id
2. Authorization: Bearer {token}
3. Content-Type: application/json

权限要求
无需登录


2. 请求体
参数名称
参数类型
默认值
是否必填
说明
email
string
""
Y
1. 邮箱地址，这里前端需要预校验格式，后端进行二次校验，如邮箱格式错误，返回 code=100
2. 验证码有效期 5min

3. 成功响应
{
    "code": 0,    // 业务码
    "msg": "success",    // 提示信息
    "data": {
        "countdown": 60  // int8, 单位秒，按钮再次触发倒计时时间，前端用于禁用按钮
        "expireAt": 1736764800    // int64, 单位秒，验证码过期时间，UNIX时间戳
    },
    "reqId": ""    // 请求id，用于问题排查
}

4. 失败响应
{
    "code": 100,    // 状态码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}




5.2.5 【PATCH】用户信息更新

1. 基础信息
信息项
规范
说明
API 地址
/api/v1/auth/user-profile

请求方式
PATCH
部分更新资源，更新哪个字段传哪个字段
传输协议
HTTPS

数据格式
JSON（Content-Type: application/json）
请求、响应均为json格式
请求头
1. X-Request-Id
2. Authorization: Bearer {token}

权限要求
需登录
请求头携带有效token令牌

2. 请求体
参数名称
参数类型
默认值
是否必填
说明
username
string
-
N
1. 用户名
2. 30字符以内，支持数字、大小写字母、下划线
email
string
-
N
用户邮箱
emailCode
string
-
N
用户邮箱验证码；和用户邮箱绑定，更改邮箱时必须请求验证码，
zone
string
-
N
用户所在国家/地区
birthday
string
-
N
生日，格式 "dd-mm-yyyy", eg: "03-04-1999" 
gender
string
-
N
性别
des
string
-
N
个人介绍 /签名

3. 成功响应
{
    "code": 0,    // 业务码
    "msg": "success",    // 提示信息
    "data": {
        "userId": "",    // string, 用户唯一ID
        "username": "",    // string, 用户名
        "email": "",    // string, 邮箱
        "zone": "",    // string, 时区
        "birthday": "",    // string, 生日
        "gender": "",    // string, 性别
        "des": "",    // string, 个性签名
        "updateTs": 1736764800    // int64, 单位秒，更新时间，UNIX时间戳
    },
    "reqId": ""    // 请求id，用于问题排查
}

4. 失败响应
{
    "code": 3200,    // 状态码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}


5.2.6 【PUT】用户口令修改

1. 基础信息
信息项
规范
说明
API 地址
/api/v1/auth/user-profile

请求方式
PUT
全量资源更新
传输协议
HTTPS

数据格式
JSON（Content-Type: application/json）
请求、响应均为json格式
请求头
1. X-Request-Id
2. Authorization: Bearer {token}

权限要求
需登录
请求头携带有效token令牌

2. 请求体
参数名称
参数类型
默认值
是否必填
说明
username
string
-
N
用户名，20字符以内，支持数字、大小写字母、下划线
email
string
-
N
用户邮箱，用户名和邮箱二选一，二者至少需要携带一个
oriPwd
string
-
Y
用户旧密码，需加密，禁止明文
newPwd
string
-
Y
用户新密码，需加密，禁止明文
confirmPwd
string
-
Y
用户密码，需加密，禁止明文

3. 成功响应
{
    "code": 0,    // 业务码
    "msg": "success",    // 提示信息
    "data": {
        "userId": "",    // string, 用户唯一ID
        "username": "",    // string, 用户名
        "email": "",    // string, 邮箱
        "updateTs": 1736764800    // int64, 单位秒，更新时间，UNIX时间戳
    },
    "reqId": ""    // 请求id，用于问题排查
}

4. 失败响应
{
    "code": 3200,    // 状态码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}




5.3 业务流程

用户操作 → 前端处理 → 后端接收 → 转发至文件服务 → 存储并返回URL → 后端同步结果给前端


5.3.1 【GET】获取任务列表

1. 基础信息
信息项
规范
说明
API 地址
/api/v1/task/{userId}/list

请求方式
GET

传输协议
HTTPS

数据格式
URL路径参数
请求为URL路径参数、响应为json格式
请求头
1. X-Request-Id
2. Authorization: Bearer {token}

权限要求
需登录
请求头携带有效token令牌

2. 请求参数
参数名称
参数类型
默认值
是否必填
说明
userId
string
""
Y
用户唯一标识

3. 成功响应
{
    "code": 0,
    "msg": "success",
    "data": {
        "userId": "",    // string, 用户唯一ID
        "taskList": [
            {
                "taskId": "",    // string, 任务id，不同用户每个任务id唯一
                "taskName": "",    // string, 任务名
                "taskStatus": "",    // string 任务状态
                "taskSize": 201,    // uint16, 任务内缓存文件总大小, 单位MiB 
                "expireAt": 1736764800,    // int64, 任务过期时间, 单位秒
                "fileList": [    // 任务内文件缓存路径，任务内文件包含：原文文件、总结文件、脑图文件、AI生成文件
                    {
                        "fileId": "",    // string, 文件唯一id
                        "fileTag": 0,    // uint8，文件标签，0-原始文件；1-总结文件；2-脑图文件；3-AI生成文件
                        "fileName": "",    // string, 文件名称
                        "fileType": "",    // string, 文件类型, eg: mp3 txt doc pdf jpg
                        "fileSize": 50,    // uint16, 文件大小, 单位MiB
                        "fileMd5": "",    // 文件完整 MD5（16进制）
                        "fileAddr": ""    // 文件服务地址
                    },
                    // 类推...
                ]
            }
            // 类推...
        ]
    },
    "reqId": ""    // string, 请求id，用于问题排查
}
4. 失败响应
{
    "code": 1,    // 状态码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}



5.3.2 【POST】任务创建

1. 基础信息
信息项
规范
说明
API 地址
/api/v1/task/{userId}/create

请求方式
POST

传输协议
HTTPS

数据格式
URL路径参数
请求为URL路径参数、响应为json格式
请求头
1. X-Request-Id
2. Authorization: Bearer {token}

权限要求
需登录
请求头携带有效token令牌

2. 请求参数
参数名称
参数类型
默认值
是否必填
说明
userId
string
""
Y
用户唯一标识
taskName
string
""
Y
任务名称

3. 成功响应
{
    "code": 0,
    "msg": "success",
    "data": {
        "userId": "",    // string, 用户唯一ID
        "taskId": "",    // string, 任务id，不同用户每个任务id唯一
        "taskName": "",    // string, 任务名
        "taskStatus": "",    // string 任务状态
        "expireAt": 1736764800    // int64, 任务过期时间, 单位秒
    },
    "reqId": ""    // string, 请求id，用于问题排查
}
4. 失败响应
{
    "code": 1,    // 状态码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}


5.4 文件管理


5.4.1 文件下载

5.4.1.1 【GET】获取文件前置信息
下载前获取文件基本信息（大小、类型、MD5），用于客户端预处理（如判断是否支持断点续传、预显示文件信息），这步其实在获取任务列表这个接口中已经有涉及，看具体的前端需求吧。

5.4.1.2 【GET】文件下载
1. 基础信息
信息项
规范
说明
API 地址
/api/v1/{taskId}/files/{fileId}/download

请求方式
GET
全量资源更新
传输协议
HTTPS

数据格式
URL查询参数
请求通过url查询参数，响应为json
请求头
1. X-Request-Id
2. Authorization: Bearer {token}
3. Range: bytes=start-end（可选）
Range: 文件字节范围请求，文件大于100M时需要考虑断点续传，此时需要设置此参数，格式：bytes=start-end（用于断点续传）
示例: 
- bytes=0-499：请求前 500 字节
- bytes=500-：请求从 500 字节到文件末尾
- 若不传递，默认返回完整文件
权限要求
需登录
请求头携带有效token令牌

2. 查询参数
参数名称
参数类型
默认值
是否必填
说明
fileAddr
string
""
N
支持直接根据文件地址（索引）从文件服务上下载文件
fileName
string

"{taskId}_{fileId}.{file extension}"
N
指定下载文件名称，默认 {taskId}_{fileId}.{file extension}


3. 成功响应
  1. 响应头：
字段名称
类型
说明
Content-Type
string
文件 MIME 类型，用于前端识别文件类型
Content-Disposition

string
控制下载行为，格式：attachment; filename*=UTF-8''{encodedFileName}
示例：attachment; filename*=UTF-8''%E9%A1%B9%E7%9B%AE%E6%96%87%E6%A1%A3.pdf（对应 “项目文档.pdf”）
Content-Length
number
单文件：文件总大小（字节数，用于客户端计算总进度）
断点续传：本次返回的字节数（end - start + 1）
Content-Range
string
仅大文件需断点续传场景下传参，本次返回的字节范围，格式：bytes start-end/total。
示例：bytes 500-1999/10000（表示返回 500-1999 字节，总大小 10000 字节）
ETag
string
文件唯一标识，W/"{taskId}_{fileId}"
Last-Modified
string
文件最后修改时间（GMT 格式，如 Wed, 21 Oct 2024 07:28:00 GMT）
Accept-Ranges
string
固定值 bytes，表示服务器支持字节范围请求
X-File-MD5
string
文件完整 MD5（16 进制，如 d41d8cd98f00b204e9800998ecf8427e，用于前端校验完整性）
X-Chunk-MD5
string
本次分块的 MD5（可选，大文件分块校验用，如 chunk-0-md5）
X-File-Type
string
后端识别的文件类型（如 pdf、mp3，用于前端二次校验）
  2. 响应体：文件完整二进制流


4. 失败响应
{
    "code": ,    // 状态码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}


5.4.2 文件上传
这里考虑到工作量，需要考虑下前后端是否需要适配断点续传

针对支持多类型（mp3、jpg、pdf 等）、大文件（2-3GB）的前端文件上传场景，接口协议需支持以下功能：
  1. 多类型
  2. 大文件
  3. 断点续传（避免重传）
  4. 分块传输（降低单次请求压力）
  5. 类型校验
  6. 进度跟踪
交互方式：前端初始化上传，分块上传，合并分块


5.4.2.1 【POST】上传初始化（获取上传凭证）
功能：校验文件基本信息（类型、大小），生成唯一上传 ID，返回分块配置（分块大小、总块数）

1. 基本信息
信息项
规范
说明
API 地址
/api/v1/{taskId}files/init-upload

请求方式
POST

传输协议
HTTPS

请求头
1. X-Request-Id
2. Authorization: Bearer {token}
3. Content-Type: application/json

数据格式
JSON（Content-Type: application/json）
请求、响应均为json格式
权限要求
需登录
请求头携带有效token令牌

2. 请求体
参数名称
参数类型
默认值
是否必填
说明
fileName
string
""
Y
原始文件名称
fileSize
int64
0
Y
原始文件总大小，单位Byte，二进制单位，如 20971520 表示 20MB
fileType
string
""
Y
文件类型，如 application/pdf、image/jpeg，前端通过 file.type 获取
fileTag
string
""
Y
文件标签，0-原始文件；1-总结文件；2-脑图文件；3-AI生成文件
fileMd5
string
""
Y
文件整体 MD5 哈希值（客户端预计算，用于后端校验文件完整性，避免重复上传）
chunkSize
int64
20971520
N
分块大小，单位Byte，默认值20MiB

3. 成功响应
{
    "code": 0,    // 业务码
    "msg": "success",    // 描述信息
    "data": {
        "uploadId": "",    // string, 用于标识本次文件上传流程的唯一ID, 后续分块上传合并需传递
        "chunkSize": 20971520,    // int64, 实际分块大小，单位Byte
        "totalChunks": 10,    // int16, 总分块数，math.ceil(fileSize / chunkSize)
        "allowedTypes": "",   // string, 后端支持的文件类型，不同类型之间用逗号间隔开
        "maxSize": 3221225472    // int64, 单位Byte，后端支持上传的最大文件大小，默认3GiB
    },
    "reqId": ""    // 请求id，用于问题排查
}

4. 失败响应
{
    "code": 1,    // 状态码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}


5.4.2.2 【GET】已上传分块校验
功能：服务中断后，校验那些分块已上传，避免重复上传

1. 基本信息
信息项
规范
说明
API 地址
/api/v1/{taskId}/files/upload/{uploadId}/check

请求方式
GET

传输协议
HTTPS

请求头
1. X-Request-Id
2. Authorization: Bearer {token}

数据格式
url路径参数
请求通过路径参数、响应为json格式
权限要求
需登录
请求头携带有效token令牌

2. 请求路径参数
参数名称
参数类型
默认值
是否必填
说明
uploadId
string
""
Y
上传Id，由上传文件初始化接口提供

3. 成功响应
{
    "code": 0,    // 业务码
    "msg": "success",    // 描述信息
    "data": {
        "uploadedChunks": [],   // array, 已上传分块的id
        "count": 10    // int16，已上传文件总块数
    },
    "reqId": ""    // 请求id，用于问题排查
}

4. 失败响应
{
    "code": 1,    // 状态码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}


5.4.2.3 【PUT】分块上传
功能：上传单个文件分块，支持并行上传，前端需要控制并发数（暂定5）

1. 基本信息
信息项
规范
说明
API 地址
/api/v1/{taskId}/files/upload/{uploadId}/chunk

请求方式
PUT

传输协议
HTTPS

请求头
1. X-Request-Id
2. Authorization: Bearer {token}
3. Content-Length
Content-Length表示当前分块的实际大小，用于后端校验完整性

数据格式
Content-Type: application/octet-stream
请求为路径参数+查询参数+文件二进制流
权限要求
需登录
请求头携带有效token令牌

2. 请求参数

  1. 路径参数 
参数名称
参数类型
默认值
是否必填
说明
taskId
string
""
Y
任务唯一标识
uploadId
string
""
Y
文件上传唯一标识
  2. 查询参数 
参数名称
参数类型
默认值
是否必填
说明
chunkIdx
int16
0
Y
分块索引（从 0 开始，如第 1 块为 0，第 2 块为 1，需与总块数对应）
chunkMd5
string
""
Y
当前分块的 MD5 哈希值（前端计算，后端校验分块完整性，避免传输损坏）
请求体为分块的二进制文件流（文件的第 chunkIndex * chunkSize 到 (chunkIndex + 1) * chunkSize - 1 字节）

3. 成功响应
{
    "code": 0,    // 业务码
    "msg": "success",    // 描述信息
    "data": {
        "chunkIdx": ""   // string, 用于标识本次文件上传流程的唯一ID, 后续分块上传合并需传递
    },
    "reqId": ""    // 请求id，用于问题排查
}

4. 失败响应
{
    "code": 1,    // 状态码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}


5.4.2.4 【POST】完成上传（合并分块）
功能：所有分块上传完成后，通知后端合并分块为完整文件，生成最终文件 ID

1. 基本信息
信息项
规范
说明
API 地址
/api/v1/{taskId}/files/upload/{uploadId}/complete

请求方式
POST

传输协议
HTTPS

请求头
1. X-Request-Id
2. Authorization: Bearer {token}
3. Content-Type: application/json

数据格式
url路径参数
请求通过路径参数、响应为json格式
权限要求
需登录
请求头携带有效token令牌

2. 请求体（JSON）
参数名称
参数类型
默认值
是否必填
说明
fileMd5
string
""
Y
文件Md5值，后端校验完整性，与初始化阶段的Md5一致
totalChunks
int16
1
Y
文件总块数，与初始化时一致，后端校验是否所有分块都已上传

3. 成功响应
{
    "code": 0,    // 业务码
    "msg": "success",    // 描述信息
    "data": {
        "fileId": "",   // string, 文件唯一标识
        "fileName": "",    // string，文件名称
        "fileSize": 0,    // int64，最终文件大小，单位Byte
        "fileAddr": "",    // string, 文件服务存储路径
        "fileTag": 0,    // uint8, 文件标签，0-原始文件；1-总结文件；2-脑图文件；3-AI生成文件
        "uploadedTs": 1736764800    // int64, 文件上传完成时UNIX时间戳，单位秒
    },
    "reqId": ""    // 请求id，用于问题排查
}

4. 失败响应
{
    "code": 1,    // 状态码
    "msg": "",    // 提示信息
    "data": {},    // 空的消息体
    "reqId": ""    // 请求id，用于问题排查
}



5.5 算法模块@飞书用户6408KZ 

5.5.1 【POST】语音分片识别（实时字幕）
1. 基础信息
信息项
规范
说明
api地址
/asr/chunk
语音分片识别接口
请求方式
POST
""
传输协议
HTTPS
""
数据格式
multipart/form-data
""
请求头
X-Request-Id,
Authorization: Bearer {token}
""
2. 请求体
参数名称
参数类型
默认值
是否必填
说明
file

file
""
Y
单个音频分片，格式支持webm / wav / m4a / mp3，后端统一转为 16k 单声道 wav
lang
string
""
N
识别语种，如 zh、en；为空则自动检测
mine
string
""
N
前端上传时的 MIME 类型
sid
string
""
N
会话 ID，用于同一会议内的说话人聚类；不开启聚类可为空
diarize
string
"on"
N
是否开启说话人聚类："on" / "off"
spk_thresh

float
-
N
说话人聚类阈值，默认后端配置（环境变量 SPK_THRESHOLD）
fast
int
1
N
解码模式：1 快速模式（贪婪搜索）
chunk_duration
float
1.0
N
当前分片时长（秒），仅用于说话人聚类权重估计
3. 成功响应
{​
"text": "识别出的文本内容",​ 
"speaker": "S1"            // 说话人标签(如启用分离)​
}
前端展示
•实时字幕区域追加显示 text；​
•如有 speaker，可在行首显示“【S1】文本”。
4. 失败响应
{
  "text": "",
  "detail": "ffmpeg 转码失败: ...",
  "hint": "frontend_mime=audio/webm"
}
5.5.2 【POST】整文件转写 + 说话人聚类

1. 基础信息
信息项
规范
说明
api地址
/asr/file_diarize
整文件识别并按说话人聚类
请求方式
POST
""
传输协议
HTTPS
""
数据格式
multipart/form-data
上传完整录音文件
请求头
X-Request-Id,Authorization: Bearer {token}
""
2. 请求体
参数名称
参数类型
默认值
是否必填
说明
file

file
""
Y
完整录音
lang
string
""
N
识别语种，如 zh、en；为空则自动检测
sid
string
""
N
会话 ID，用于跨分段保持说话人 ID 一致
spk_thresh

float
-
N
切片窗口大小（毫秒），默认 5s
window_ms
int
5000
N
解码模式：1 快速模式（贪婪搜索），0 高精度模式
3. 成功响应
{​  
"text": "S1: 大家好...\nS2: 我补充几点...\nS1: 那我们达成一致...",​ 
"lines": [​   
"S1: 大家好...",​  
"S2: 我补充几点...",​  
"S1: 那我们达成一致..."​  
]​
}​
​
前端展示
- “完整转写”区域展示 text；
- 如需逐行渲染，可使用 lines 数组生成一行一条的气泡或列表。
4. 失败响应
5.5.3【POST】转写文本修复（加标点）
1. 基本信息
信息项
规范
说明
api地址
/repair
文本修复接口
请求方式
POST
JSON 请求
传输协议
HTTPS

数据格式
application/json

2. 请求体
参数名称
参数类型
默认值
是否必填
说明
transcript
string
""
Y
原始转写文本（无标点 / 断句不佳）
3. 成功响应
{​  
"text": "S1: 大家好，今天我们主要讨论两个问题。首先，是项目进度；其次，是下周的发布安排。"​
}
前端展示
•在“修复后文本”区域显示 text，用于后续生成摘要或导出。
4. 失败响应
{​ 
"text": "原始文本...",​
"detail": "repair network error"​
}​
​

5.5.4【POST】生成会议/论文总结 & 思维导图大纲
1. 基础信息
信息项
规范
说明
api地址
/summarize
会议总结 / 论文草稿概要生成接口
请求方式
POST
JSON 请求
传输协议
HTTPS

数据格式
application/json

2. 请求体
参数名称
参数类型
默认值
是否必填
说明
transcript

string
""
Y
完整转写文本（建议使用修复后的文本）
out_lang
string
"zh"
N
输出语言，例如 "zh" / "en"
model
string
"deepseek-chat"
N
使用的大模型名称
mode
string
-
N
"meeting"：会议模式；"paper"：论文模式
3. 成功响应
{​
"summary": "### 会议摘要（含分析 & 要点）\n- 本次会议主要确认了三项决策...\n- ...",​
"outline_md": "# 会议思维导图\n## 议题一：项目进度\n- 当前进度\n- 风险点\n## 议题二：发布计划\n- 时间节点\n- 负责人"​
}​
​
前端展示
•summary 渲染到“会议总结”区域（支持 Markdown）；​
•outline_md 用于右侧思维导图（前端使用 markmap 渲染）。
4. 失败响应
{​ 
"code": 500,​
"msg": "LLM 调用失败",​
"data": null,​ 
"reqId": "..."​
}​
​
5.5.5【POST】生成论文框架 & Word 文档
1. 基础信息
信息项
规范
说明
api地址
/paper/outline
论文草稿 + Word 导出接口
请求方式
POST
JSON
传输协议
HTTPS

数据格式
application/json

2. 请求体
参数名称
参数类型
默认值
是否必填
说明
transcript

string
""
Y
会议转写文本
out_lang
string
"zh"
N
论文输出语言
model
int
"deepseek-chat
N
大模型名称
3. 成功响应
{​  
"outline_md": "# 论文标题...\n## 摘要\n...",​
"docx_b64": "BASE64_STRING",​
"has_samples": true,​
"message": "已生成完整的论文草稿，包含详细的内容和示例"​
}​
前端展示
•使用 outline_md 做论文预览；​
•docx_b64 前端解码为 .docx 文件，提供“下载论文 Word”按钮。
4. 失败响应
当 python-docx 缺失或 LLM 失败时，docx_b64 可能为空，outline_md 仍会返回 Markdown 草稿，可在前端提示“仅提供 Markdown 预览”。
5.5.6【POST】思维导图 Markdown 生成
1. 基础信息
信息项
规范
说明
api地址
/mindmap/generate
思维导图 Markdown 生成
请求方式
POST
JSON
传输协议
HTTPS
""
数据格式
application/json
上传完整录音文件
2. 请求体
参数名称
参数类型
默认值
是否必填
说明
content
string
""
Y
原始内容：可以是普通文本，也可以是已整理好的 Markdown
title
string
"思维导图"
N
思维导图标题，用作根节点
3. 成功响应
{​  
"success": true,​
"markdown": "# 思维导图\n## 要点一\n- 子节点\n## 要点二\n- 子节点",​
"title": "思维导图"​
}​
前端展示
•使用 markdown 和 title 渲染 markmap；​
•若 content 本身就是 Markdown，接口会基本保持结构不变。
4. 失败响应
{​
"success": false,​ 
"error": "思维导图生成错误: xxx"​
}​
前端可弹 toast 或在图区域展示错误提示。
5.5.7【POST】翻译模块（单条）
1. 基础信息
信息项
规范
说明
api地址
/translate
单条文本翻译
请求方式
POST
JOSN
传输协议
HTTPS

数据格式
application/json
上传完整录音文件
2. 请求体
参数名称
参数类型
默认值
是否必填
说明
text

string
""
Y
待翻译文本
src_lang
string
null
N
源语言，可为空表示自动检测
tgt_lang
string
"en"
N
目标语言，如 "zh" / "en" 等
model
string
deepseek-chat"
N
使用的 LLM 模型名
3. 成功响应
{​ 
"translation": "This is the translated text.",​
"detail": "m2m100 failed: ..., fallback to deepseek",​
"fallback": true​
}​
​
detail、fallback 仅在降级时出现，可选。
前端展示•文本区域展示 translation；​
•如 fallback = true 可在 UI 显示“小提示：已使用备用翻译引擎”。
5.5.8【POST】多文件关联分析
1. 基础信息
信息项
规范
说明
api地址
/analyze/multi_files
 多文稿分析
请求方式
POST
JSON
传输协议
HTTPS
""
数据格式
application/json

2. 请求体
参数名称
参数类型
默认值
是否必填
说明
transcripts

string[]

[]

Y
多个转写文本数组，至少 2 个
analysis_type
string
"meeting"
N
"meeting"：会议视角；"paper"：研究视角
out_lang
string
"zh"
N
输出语言
model
string
"deepseek-chat"
N
模型名称
3. 成功响应
{​ 
"analysis": "### 总体会议趋势分析\n- ...\n\n### 各会议核心内容概要\n- ...",​
"transcript_count": 3,​
"analysis_type": "meeting"​
}​
​
